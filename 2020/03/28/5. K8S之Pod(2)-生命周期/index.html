<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>5. K8S之Pod(2)-生命周期 | 海龟先生</title><meta name="description" content="K8S 是个好东西"><meta name="keywords" content="K8S"><meta name="author" content="海龟先生"><meta name="copyright" content="海龟先生"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://haiguixiansheng.org.cn/2020/03/28/5. K8S之Pod(2)-生命周期/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="5. K8S之Pod(2)-生命周期"><meta name="twitter:description" content="K8S 是个好东西"><meta name="twitter:image" content="http://haiguixiansheng.org.cn/img/k8s.jpg"><meta property="og:type" content="article"><meta property="og:title" content="5. K8S之Pod(2)-生命周期"><meta property="og:url" content="http://haiguixiansheng.org.cn/2020/03/28/5. K8S之Pod(2)-生命周期/"><meta property="og:site_name" content="海龟先生"><meta property="og:description" content="K8S 是个好东西"><meta property="og:image" content="http://haiguixiansheng.org.cn/img/k8s.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="6. K8S之资源对象" href="http://haiguixiansheng.org.cn/2020/04/11/6. K8S之资源对象/"><link rel="next" title="4. K8S之Pod(1)-基础概念" href="http://haiguixiansheng.org.cn/2020/03/27/4. K8S之Pod(1)-基础概念/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script></head><body><canvas class="fireworks"></canvas><div id="web_bg"></div><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#5-K8S之Pod-2-生命周期"><span class="toc-number">1.</span> <span class="toc-text">5. K8S之Pod(2)-生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#init容器"><span class="toc-number">1.1.</span> <span class="toc-text">init容器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod-phasePod的相位"><span class="toc-number">1.2.</span> <span class="toc-text">Pod phasePod的相位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K8S-Pod-status的状态分析"><span class="toc-number">1.3.</span> <span class="toc-text">K8S Pod status的状态分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod健康检查-存活性探测"><span class="toc-number">1.4.</span> <span class="toc-text">Pod健康检查 (存活性探测)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子"><span class="toc-number">1.4.1.</span> <span class="toc-text">Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子</span></a></li></ol></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/k8s.jpg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">海龟先生</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><div class="menu_mask"></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item text-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">52</div></a></div></div><div class="mobile_data_item text-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">6</div></a></div></div><div class="mobile_data_item text-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title"><div class="posttitle">5. K8S之Pod(2)-生命周期</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-03-28<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-02-25</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Kubernetes/">Kubernetes</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2.5k</span><span class="post-meta__separator">|</span><span>阅读时长: 8 分钟</span><span class="post-meta__separator">|</span><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="5-K8S之Pod-2-生命周期"><a href="#5-K8S之Pod-2-生命周期" class="headerlink" title="5. K8S之Pod(2)-生命周期"></a>5. K8S之Pod(2)-生命周期</h1><p>如图</p>
<p><img alt="生命周期" data-src="https://gitee.com/mrhaigui/images_source/raw/master/k8s/pod-life.jpg" class="lozad"></p>
<h2 id="init容器"><a href="#init容器" class="headerlink" title="init容器"></a>init容器</h2><p><a href="https://kubernetes.io/docs/concepts/abstractions/pod/" target="_blank" rel="noopener">Pod</a> 能够具有多个容器，应用运行在容器里面，但是它也可能有一个或多个先于应用容器启动的 Init 容器。</p>
<p>Init 容器与普通的容器非常像，除了如下两点：</p>
<ul>
<li>Init 容器总是运行到成功完成为止。</li>
<li>每个 Init 容器都必须在下一个 Init 容器启动之前成功完成。（串行）</li>
</ul>
<p>如果 Pod 的 Init 容器失败，Kubernetes 会不断地重启该 Pod，直到 Init 容器成功为止。然而，如果 Pod 对应的 <code>restartPolicy</code> 为 Never，它不会重新启动。</p>
<h2 id="Pod-phasePod的相位"><a href="#Pod-phasePod的相位" class="headerlink" title="Pod phasePod的相位"></a>Pod phasePod的相位</h2><p>Pod 的 <code>status</code> 在信息保存在 <a href="https://kubernetes.io/docs/resources-reference/v1.7/#podstatus-v1-core" target="_blank" rel="noopener">PodStatus</a> 中定义，其中有一个 <code>phase</code> 字段。</p>
<p>Pod 的相位（phase）是 Pod 在其生命周期中的简单宏观概述。该阶段并不是对容器或 Pod 的综合汇总，也不是为了做为综合状态机。</p>
<p>Pod 相位的数量和含义是严格指定的。除了本文档中列举的状态外，不应该再假定 Pod 有其他的 <code>phase</code>值。</p>
<p>下面是 <code>phase</code> 可能的值：</p>
<ul>
<li><strong>挂起（Pending）</strong>：API Server创建了Pod资源对象并已经存入了etcd中，但是它并未被调度完成，或者仍然处于从仓库下载镜像的过程中。</li>
<li><strong>运行中（Running）</strong>：Pod已经被调度到某节点之上，并且所有容器都已经被kubelet创建完成。</li>
<li><strong>成功（Succeeded）</strong>：Pod 中的所有容器都被成功终止，并且不会再重启。</li>
<li><strong>失败（Failed）</strong>：Pod 中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非0状态退出或者被系统终止。</li>
<li><strong>未知（Unknown）</strong>：因为某些原因无法取得 Pod 的状态，通常是因为与 Pod 所在主机通信失败。</li>
</ul>
<p>下图是Pod的生命周期示意图，从图中可以看到Pod状态的变化。</p>
<p><img alt="img" data-src="https://gitee.com/mrhaigui/images_source/raw/master/k8s/pod-status.jpg" class="lozad"></p>
<h2 id="K8S-Pod-status的状态分析"><a href="#K8S-Pod-status的状态分析" class="headerlink" title="K8S Pod status的状态分析"></a>K8S Pod status的状态分析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CrashLoopBackOff： 容器退出，kubelet正在将它重启</span><br><span class="line">InvalidImageName： 无法解析镜像名称</span><br><span class="line">ImageInspectError： 无法校验镜像</span><br><span class="line">ErrImageNeverPull： 策略禁止拉取镜像</span><br><span class="line">ImagePullBackOff： 正在重试拉取</span><br><span class="line">RegistryUnavailable： 连接不到镜像中心</span><br><span class="line">ErrImagePull： 通用的拉取镜像出错</span><br><span class="line">CreateContainerConfigError： 不能创建kubelet使用的容器配置</span><br><span class="line">CreateContainerError： 创建容器失败</span><br><span class="line">m.internalLifecycle.PreStartContainer  执行hook报错</span><br><span class="line">RunContainerError： 启动容器失败</span><br><span class="line">PostStartHookError： 执行hook报错 </span><br><span class="line">ContainersNotInitialized： 容器没有初始化完毕</span><br><span class="line">ContainersNotReady： 容器没有准备完毕 </span><br><span class="line">ContainerCreating：容器创建中</span><br><span class="line">PodInitializing：pod 初始化中 </span><br><span class="line">DockerDaemonNotReady：docker还没有完全启动</span><br><span class="line">NetworkPluginNotReady： 网络插件还没有完全启动</span><br></pre></td></tr></table></figure>

<h2 id="Pod健康检查-存活性探测"><a href="#Pod健康检查-存活性探测" class="headerlink" title="Pod健康检查 (存活性探测)"></a>Pod健康检查 (存活性探测)</h2><p>Pod启动后的健康状态可以由两类探针来检测：<strong>Liveness Probe（存活性探测） 和 Readiness Probe（就绪性探测）</strong>。如下图：</p>
<p><img alt="生命周期" data-src="https://gitee.com/mrhaigui/images_source/raw/master/k8s/pod-life.jpg" class="lozad"></p>
<p><strong>1. Readiness Probe</strong><br><strong>1.</strong> 用于判断容器是否启动完成（read状态），可以接受请求。<em>容器虽然起来了，但是里面的服务启动还是需要一会儿的</em><br><strong>2.</strong> 如果ReadnessProbe探针检测失败，则Pod的状态将被修改。Endpoint Controller将从Service的Endpoint中删除包含该容器所在Pod的Endpoint。</p>
<p>readinessProbe：指示容器是否准备好服务请求。如果就绪探测失败，端点控制器将从与 Pod 匹配的所有 Service 的端点中删除该 Pod 的 IP 地址。初始延迟之前的就绪状态默认为 Failure。如果容器不提供就绪探针，则默认状态为 Success。Kubelet使用readiness probe（就绪探针）来确定容器是否已经就绪可以接受流量。只有当Pod中的容器都处于就绪状态时kubelet才会认定该Pod处于就绪状态。该信号的作用是控制哪些Pod应该作为service的后端。如果Pod处于非就绪状态，那么它们将会被从service的load balancer中移除。</p>
<p><strong>2. Liveness Probe</strong><br><strong>1.</strong> 用于判断容器是否存活（running状态）。<br><strong>2.</strong> 如果LivenessProbe探针探测到容器非健康，则kubelet将杀掉该容器，并根据容器的<code>重启策略</code>做相应处理。<br><strong>3.</strong> 如果容器不包含LivenessProbe探针，则kubelet认为该探针的返回值永远为“success”。</p>
<p><code>livenessProbe</code>：指示容器是否正在运行。如果存活探测失败，则 kubelet 会杀死容器，并且容器将受到其 重启策略 的影响。如果容器不提供存活探针，则默认状态为 Success。Kubelet使用liveness probe（存活探针）来确定何时重启容器。</p>
<p><strong>Kubelet 可以选择是否执行在容器上运行的两种探针执行和做出反应，每次探测都将获得以下三种结果之一：</strong><br>成功：容器通过了诊断。<br>失败：容器未通过诊断。<br>未知：诊断失败，因此不会采取任何行动。</p>
<p><strong>探针是由 kubelet 对容器执行的定期诊断。要执行诊断，kubelet 调用由容器实现的Handler。其存活性探测的方法有以下三种：</strong><br>- ExecAction：在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功。<br>- TCPSocketAction：对指定端口上的容器的 IP 地址进行 TCP 检查。如果端口打开，则诊断被认为是成功的。<br>- HTTPGetAction：对指定的端口和路径上的容器的 IP 地址执行 HTTP Get 请求。如果响应的状态码大于等于200 且小于 400，则诊断被认为是成功的。</p>
<p>拿<code>LivenessProbe</code>来举例：</p>
<ul>
<li>ExecAction: </li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    test:</span> <span class="string">liveness-tcp</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">liveness-tcp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">liveness-tcp-demo</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">nginx:1.12-alpine</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    livenessProbe:</span></span><br><span class="line"><span class="attr">      apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    test:</span> <span class="string">liveness-exec</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">liveness-exec</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">liveness-exec-demo</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    args:</span> <span class="string">["/bin/sh","-c","touch</span> <span class="string">/tmp/healthy;sleep</span> <span class="number">60</span><span class="string">;rm</span> <span class="bullet">-rf</span> <span class="string">/tmp/healthy;sleep</span> <span class="number">600</span><span class="string">"]</span></span><br><span class="line"><span class="string">    livenessProbe:</span></span><br><span class="line"><span class="string">      exec:</span></span><br><span class="line"><span class="string">        command: ["</span><span class="string">test","-e","/tmp/healthy"]</span></span><br><span class="line"><span class="attr">      initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">      periodSeconds:</span> <span class="number">5</span><span class="string">:</span></span><br><span class="line"><span class="attr">        port:</span> <span class="string">http</span></span><br></pre></td></tr></table></figure>

<ul>
<li>TCPSocketAction</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    test:</span> <span class="string">liveness-tcp</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">liveness-tcp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">liveness-tcp-demo</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">nginx:1.12-alpine</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    livenessProbe:</span></span><br><span class="line"><span class="attr">      tcpSocket:</span></span><br><span class="line"><span class="attr">        port:</span> <span class="string">http</span></span><br></pre></td></tr></table></figure>

<ul>
<li>HTTPGetAction</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    test:</span> <span class="string">liveness-http</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">liveness-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">liveness-http-demo</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">nginx:1.12-alpine</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    lifecycle:</span></span><br><span class="line"><span class="attr">      postStart:</span></span><br><span class="line"><span class="attr">        exec:</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">["/bin/sh","-c","echo</span> <span class="string">healthy</span> <span class="string">&gt; /usr/share/nginx/html/healthy"]</span></span><br><span class="line"><span class="string"></span><span class="attr">    livenessProbe:</span></span><br><span class="line"><span class="attr">      httpGet:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/healthy</span></span><br><span class="line"><span class="attr">        port:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">        scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">    initialDelaySeconds:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">    periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p><strong><em>ReadnessProbe 同理</em></strong></p>
<p><strong>配置Probe</strong><br>Probe中有很多精确和详细的配置，通过它们你能准确的控制liveness和readiness检查：<br><code>initialDelaySeconds</code>：容器启动后第一次执行探测是需要等待多少秒。即启动容器后首次进行健康检查的等待时间，单位为秒。<br><code>periodSeconds</code>：执行探测的频率。默认是10秒，最小1秒。<br><code>timeoutSeconds</code>：探测超时时间。默认1秒，最小1秒。即健康检查发送请求后等待响应的时间，如果超时响应kubelet则认为容器非健康，重启该容器，单位为秒。<br><code>successThreshold</code>：探测失败后，最少连续探测成功多少次才被认定为成功。默认是1。对于liveness必须是1。最小值是1。<br><code>failureThreshold</code>：探测成功后，最少连续探测失败多少次才被认定为失败。默认是3。最小值是1。</p>
<p>等等。。。</p>
<p>具体还是自己查查。。。</p>
<p>对于HTTP探测器，kubelet向指定的路径和端口发送HTTP请求以执行检查。 Kubelet将probe发送到容器的IP地址，除非地址被httpGet中的可选host字段覆盖。 在大多数情况下，不想设置主机字段。 有一种情况下可以设置它， 假设容器在127.0.0.1上侦听，并且Pod的hostNetwork字段为true。 然后，在httpGet下的host应该设置为127.0.0.1。 如果你的pod依赖于虚拟主机，这可能是更常见的情况，你不应该是用host，而是应该在httpHeaders中设置Host头。</p>
<p><strong>Liveness Probe和Readiness Probe使用场景</strong></p>
<ul>
<li>如果容器中的进程能够在遇到问题或不健康的情况下自行崩溃，则不一定需要存活探针; kubelet 将根据 Pod 的restartPolicy 自动执行正确的操作。</li>
<li>如果希望容器在探测失败时被杀死并重新启动，那么请指定一个存活探针，并指定restartPolicy 为 Always 或 OnFailure。</li>
<li>如果要仅在探测成功时才开始向 Pod 发送流量，请指定就绪探针。在这种情况下，就绪探针可能与存活探针相同，但是 spec 中的就绪探针的存在意味着 Pod 将在没有接收到任何</li>
<li>流量的情况下启动，并且只有在探针探测成功后才开始接收流量。</li>
<li>如果你希望容器能够自行维护，您可以指定一个就绪探针，该探针检查与存活探针不同的端点。</li>
</ul>
<p><strong>说明：</strong> 请注意，如果你只是想在 Pod 被删除时能够排空请求，则不一定需要使用就绪态探针； 在删除 Pod 时，Pod 会自动将自身置于未就绪状态，无论就绪态探针是否存在。 等待 Pod 中的容器停止期间，Pod 会一直处于未就绪状态。</p>
<h3 id="Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子"><a href="#Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子" class="headerlink" title="Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子"></a>Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子</h3><p>在主容器刚刚启动之后，用户可以手动嵌入做一些操作，可以做一个 post start，比如执行完一个命令就退出。<br>如果主容器要退出，在结束之前，也可以做一些事情，pre stop。类似于awk的BEGIN和END。</p>
<p>Kubernetes 为我们提供了两种钩子函数：</p>
<ul>
<li>PostStart：这个钩子在容器创建后立即执行。但是，并不能保证钩子将在容器<code>ENTRYPOINT</code>之前运行，因为没有参数传递给处理程序。主要用于资源部署、环境准备等。不过需要注意的是如果钩子花费太长时间以至于不能运行或者挂起， 容器将不能达到<code>running</code>状态。</li>
<li>PreStop：这个钩子在容器终止之前立即被调用。它是阻塞的，意味着它是同步的， 所以它必须在删除容器的调用发出之前完成。主要用于优雅关闭应用程序、通知其他系统等。如果钩子在执行期间挂起， Pod阶段将停留在<code>running</code>状态并且永不会达到<code>failed</code>状态。</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">海龟先生</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://haiguixiansheng.org.cn/2020/03/28/5. K8S之Pod(2)-生命周期/">http://haiguixiansheng.org.cn/2020/03/28/5. K8S之Pod(2)-生命周期/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://haiguixiansheng.org.cn">海龟先生</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/K8S/">K8S    </a></div><div class="post_share"><div class="social-share" data-image="/img/k8s.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/04/11/6. K8S之资源对象/"><img class="prev_cover lozad" data-src="/img/k8s.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>6. K8S之资源对象</span></div></a></div><div class="next-post pull-right"><a href="/2020/03/27/4. K8S之Pod(1)-基础概念/"><img class="next_cover lozad" data-src="/img/k8s.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>4. K8S之Pod(1)-基础概念</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/06/03/源服务器搭建以及deb包制作文档/" title="源服务器搭建以及deb包制作文档"><img class="relatedPosts_cover lozad" data-src="/img/linux.png"><div class="relatedPosts_title">源服务器搭建以及deb包制作文档</div></a></div><div class="relatedPosts_item"><a href="/2020/05/22/12. K8S之configMap/" title="12. K8S之configMap"><img class="relatedPosts_cover lozad" data-src="/img/k8s.jpg"><div class="relatedPosts_title">12. K8S之configMap</div></a></div><div class="relatedPosts_item"><a href="/2020/05/22/11. K8S之Ingress/" title="11. K8S之Ingress"><img class="relatedPosts_cover lozad" data-src="/img/k8s.jpg"><div class="relatedPosts_title">11. K8S之Ingress</div></a></div><div class="relatedPosts_item"><a href="/2020/05/20/10. K8S之svc/" title="10. K8S之svc"><img class="relatedPosts_cover lozad" data-src="/img/k8s.jpg"><div class="relatedPosts_title">10. K8S之svc</div></a></div><div class="relatedPosts_item"><a href="/2020/05/20/9. K8S之deployment/" title="9. K8S之deployment"><img class="relatedPosts_cover lozad" data-src="/img/k8s.jpg"><div class="relatedPosts_title">9. K8S之deployment</div></a></div><div class="relatedPosts_item"><a href="/2020/04/15/8. K8S之常用命令/" title="8. K8S 之常用命令"><img class="relatedPosts_cover lozad" data-src="/img/k8s.jpg"><div class="relatedPosts_title">8. K8S 之常用命令</div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80NjY1Ny8yMzE2Nw=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></div></div><footer><div id="footer"><div class="copyright">&copy;2018 - 2021 By 海龟先生</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://www.cnblogs.com/haiguixiansheng/">blog</a>!</div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><a id="to_comment" href="#post-comment"><i class="scroll_to_comment fa fa-comments"></i></a><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></section><div class=" " id="post_bottom"><div id="post_bottom_items"><a id="mobile_to_comment" href="#post-comment"><i class="mobile_scroll_to_comment fa fa-comments"></i></a><i class="fa fa-list" id="mobile_toc"></i><div id="toc_mobile"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#5-K8S之Pod-2-生命周期"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">5. K8S之Pod(2)-生命周期</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#init容器"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">init容器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pod-phasePod的相位"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">Pod phasePod的相位</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#K8S-Pod-status的状态分析"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">K8S Pod status的状态分析</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pod健康检查-存活性探测"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">Pod健康检查 (存活性探测)</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子"><span class="toc_mobile_items-number">1.4.1.</span> <span class="toc_mobile_items-text">Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子</span></a></li></ol></li></ol></li></ol></div></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script src="/js/nightshift.js"></script><script id="ribbon" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/js/piao.js"></script><script color="0,0,255" opacity="0.7" zindex="-1" count="99" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN/js/canvas-nest.js"></script><script src="/js/activate-power-mode.js"></script><script>POWERMODE.colorful = true; // make power mode colorful
POWERMODE.shake = true; // turn off shake
document.body.addEventListener('input', POWERMODE);
</script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();</script></body></html>